<!DOCTYPE html>
<html prefix="" lang="pt_br">
<head>
<meta charset="utf-8">
<meta name="description" content="Uma pequena ajuda mais prática que técnica ou teórica para quem está aprendendo sobre NLP">
<meta name="viewport" content="width=device-width">
<title>Anotações sobre NLP</title>
<link href="assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="assets/css/code.css" rel="stylesheet" type="text/css">
<link href="assets/css/dark.css" rel="stylesheet" type="text/css">
<link href="assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono" rel="stylesheet">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://demacdolincoln.github.io/anotacoes-nlp/posts/">
<link rel="next" href="index-1.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script src="https://cdn.jsdelivr.net/npm/vega@4.4.0"></script><script src="https://cdn.jsdelivr.net/npm/vega-lite@2.6.0"></script><script src="https://cdn.jsdelivr.net/npm/vega-embed@3.24.2"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/languages/python.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/languages/julia.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script><link rel="prefetch" href="posts/classificacao-4-rnn-parte-2-%2B-convolucao/" type="text/html">
</head>
<body class="hack dark">

<a href="#content" class="sr-only sr-only-focusable">Pular para o conteúdo principal</a>
    <div id="container">
         
    <header id="header"><h1 id="brand"><a href="http://demacdolincoln.github.io/anotacoes-nlp/posts/" title="Anotações sobre NLP" rel="home">

        <span id="blog-title">Anotações sobre NLP</span>
    </a></h1>

        

        
    <nav id="menu"><ul>
<li><a href="archive.html">Arquivo</a></li>
                <li><a href="categories/">Etiqueta</a></li>
                <li><a href="rss.xml">Feed RSS</a></li>

    

    
    
    </ul></nav></header><main id="content"><div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/classificacao-4-rnn-parte-2-%2B-convolucao/" class="u-url">Classificação 4: RNN parte 2 (+ convolução)</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/classificacao-4-rnn-parte-2-%2B-convolucao/" rel="bookmark">
            <time class="published dt-published" datetime="2019-01-26T23:48:33-03:00" itemprop="datePublished" title="2019-01-26 23:48">2019-01-26 23:48</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/classificacao-4-rnn-parte-2-%2B-convolucao/#disqus_thread" data-disqus-identifier="cache/posts/classificacao-4-rnn-parte-2-+-convolucao.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">os códigos estão aqui: <a class="reference external" href="https://github.com/demacdolincoln/test-sentiment_analysis">https://github.com/demacdolincoln/test-sentiment_analysis</a></p>
</div>
<p>Admito que eu já disse tudo o que precisava dizer nos posts anteriores, para os testes dessa última etapa, usei 2 redes neurais com apenas 1 diferença entre elas, uma usa convolução 1d e outra 2d, e por não ter muito o que falar no momento vamos direto ao que interessa.</p>
<div class="section" id="procedimentos">
<h2>Procedimentos</h2>
<ol class="arabic">
<li>
<p class="first">init_hidden</p>
</li>
<li>
<p class="first">recurrence (lstm)</p>
</li>
<li>
<p class="first">convolução</p>
<blockquote>
<ol class="lowerroman simple">
<li>convolução (nn.Conv)</li>
<li>ReLu</li>
<li>MaxPool</li>
<li>BatchNorm</li>
</ol>
</blockquote>
</li>
<li>
<p class="first">funções lineares (3 no total)</p>
</li>
</ol>
</div>
<div class="section" id="resultados">
<h2>Resultados:</h2>
<img alt="/images/classification_conv_rnn.png" src="images/classification_conv_rnn.png"><p>É interessante notar que mesmo não alcançando um bom resultado, o aprendizado com a convolução 1d indica um aprendizado mais "real" dentre todos até agora, talvez se seguisse o aprendizado por mais 50 ou até mesmo 100 épocas, a acurácia talvez se equiparasse à convolução 2d.</p>
<p>Sobre a convolução 2d fica bem claro que mesmo mesmo alcançando basicamente o mesmo resultado que sem convolução, a distância entre a linha que representa os percentuais de acertos para os dados de treinamento em relação aos de teste é o maior dentre os 4 testes com redes convolucionais, isso indica um ajuste mais rápido ao treinamento ainda que para os testes tenha chegado no mesmo limite que na rnn sem convolução.</p>
<p>Resumindo os parágrafos anteriores, a convolução 1d + rnn leva a um aprendizado mais lento, o que não é ruim, aprender muito rápido nesse contexto significa não explorar adequadamente o espaço de busca a ser percorrido pela otimização (gosto de definir algoritmos de otimização como uma busca heurística num hiperplano altamente irregular na maioria dos casos), aprender devagar tem seu lado bom mas pela ausência de garantias que chegará em aproximadamente 75% de acerto nos dados de teste, só posso concluir que tende ao underfitting, especialmente por nenhum experimento que fiz, mesmo com taxa de aprendizado mais alta conseguiu chegar a tal resultado, porém só posso ter certeza treinando por mais épocas. Por outro lado a convolução 2d + rnn tendeu ao overfitting, isso fica bem claro pela distância crescente entre a acurácia para dados de testes e treinamento. Resumindo o resumo: neste caso não necessariamente adicionar etapas como a convolução foi um bom negócio.</p>
<p>---</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name">
<col class="field-body">
<tbody valign="top"><tr class="field">
<th class="field-name">post scriptum:</th>
<td class="field-body">Pensei em fazer um post final com um resumo geral, mas agora considero isso desnecessário, no repositório ainda bagunçado com os códigos desse experimento há um notebook chamado <em>"relatorio.ipynb"</em> onde estão os gráficos e uma tabela que indica coisas como quantidade de épocas taxas de aprendizado usadas.</td>
</tr></tbody>
</table>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/classificacao-3-rnn-parte-1/" class="u-url">Classificação 3: RNN parte 1</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/classificacao-3-rnn-parte-1/" rel="bookmark">
            <time class="published dt-published" datetime="2019-01-20T18:08:26-03:00" itemprop="datePublished" title="2019-01-20 18:08">2019-01-20 18:08</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/classificacao-3-rnn-parte-1/#disqus_thread" data-disqus-identifier="cache/posts/classificacao-3-rnn-parte-1.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">os códigos estão aqui: <a class="reference external" href="https://github.com/demacdolincoln/test-sentiment_analysis">https://github.com/demacdolincoln/test-sentiment_analysis</a></p>
</div>
<p>Nste primeiro experimento com redes neurais recorrentes, vamos apenas analisar o efeito da própria recorrência com o LSTM e GRU. Preliminarmente é preciso compreender alguns aspectos:</p>
<ol class="arabic simple">
<li>O que faremos com o skip-gram treinado pelo Gensim?</li>
<li>Em quê o LSTM ou o GRU poderão influenciar?</li>
<li>Se a entrada tem tamanho variável, como internamente fica a rede neural?</li>
</ol>
<p>Antes de chegar a essas explicações, essa é a classe que contém nossa rede neural:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-1"> 1</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-2"> 2</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-3"> 3</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-4"> 4</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-5"> 5</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-6"> 6</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-7"> 7</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-8"> 8</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-9"> 9</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-10">10</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-11">11</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-12">12</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-13">13</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-14">14</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-15">15</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-16">16</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-17">17</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-18">18</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-19">19</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-20">20</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-21">21</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-22">22</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-23">23</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-24">24</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-25">25</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-26">26</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-27">27</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-28">28</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-29">29</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-30">30</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-31">31</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-32">32</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-33">33</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-34">34</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-35">35</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-36">36</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-37">37</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-38">38</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-39">39</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-40">40</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-41">41</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-42">42</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-43">43</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-44">44</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-45">45</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-46">46</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-47">47</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-48">48</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-49">49</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-50">50</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-51">51</a>
<a href="posts/classificacao-3-rnn-parte-1/#rest_code_edc7571fa314496bb1beb8a61c805a6f-52">52</a></pre></div></td>
<td class="code"><pre class="code python"><a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-1"></a><span class="k">class</span> <span class="nc">RNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-3"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">RNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-4"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-10"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">({</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-13"></a>            <span class="s2">"weight"</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">wv</span><span class="o">.</span><span class="n">vectors</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-14"></a>        <span class="p">})</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-15"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-16"></a>        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="s2">"gru"</span><span class="p">:</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">recurrence</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-18"></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">is</span> <span class="s2">"lstm"</span><span class="p">:</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">recurrence</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-20"></a>        <span class="k">else</span><span class="p">:</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-21"></a>            <span class="k">raise</span> <span class="s2">"escolha entre gru e lstm apenas"</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-22"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear0</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">hidden</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">hidden</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hidden</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">hidden</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-26"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-27"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inpt</span><span class="p">):</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-28"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-29"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_hidden</span><span class="p">(</span><span class="n">inpt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-30"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-31"></a>        <span class="n">x</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrence</span><span class="p">(</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">inpt</span><span class="p">),</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-33"></a>            <span class="n">hidden</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-34"></a>        <span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-35"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-36"></a>        <span class="n">space</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-37"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-38"></a>        <span class="n">space</span><span class="p">[:</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-39"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">space</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-40"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-41"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-42"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-43"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-44"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-45"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-46"></a>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-47"></a>    <span class="k">def</span> <span class="nf">_init_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-48"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">"lstm"</span><span class="p">:</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-49"></a>            <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">),</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-50"></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">))</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-51"></a>        <span class="k">else</span><span class="p">:</span>
<a name="rest_code_edc7571fa314496bb1beb8a61c805a6f-52"></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
</pre></td>
</tr></table>
<div class="section" id="o-que-faremos-com-o-skip-gram-treinado-pelo-gensim">
<h2>1. O que faremos com o skip-gram treinado pelo Gensim?</h2>
<p>A camada incorporada tem uma dupla função: converter a entrada (array de inteiros e de tamanho variável) em uma matriz de largura fixa, útil à célula que cuidará da recorrência, e aplicar o skip-gram, por isso ela precisa ter as seguintes dimensões [tamanho do vocabulario x dimensões do skip-gram], O que é devolvido por esta camada é uma matriz no formato [quantidade de palavras x dimensões do skip-gram].</p>
<pre class="code python"><a name="rest_code_74c5992f789a45a59200b572424a91af-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="rest_code_74c5992f789a45a59200b572424a91af-2"></a><span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">({</span>
<a name="rest_code_74c5992f789a45a59200b572424a91af-3"></a>    <span class="s2">"weight"</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">wv</span><span class="o">.</span><span class="n">vectors</span><span class="p">)</span>
<a name="rest_code_74c5992f789a45a59200b572424a91af-4"></a><span class="p">})</span>
</pre>
<p>Outro fator importante que precisa ser mencionado é que esta camada também está sujeita ao treinamento da rede neural, ou seja, mantendo desse modo como está, estamos aplicando uma transferência neural, ou seja utilizando uma rede já treinada (no caso skip-gram) e continuando seu treinamento aplicado a uma outra situação, cujo treinamento neste novo contexto tende a ter um ponto de partida com maior precisão, esta é a idéia por trás da escolha de manter o treinamento ativo nesta camada, fazer com que o conteúdo aprendido no treinamento feito pelo Gensim vá se adaptando ao contexto da análise de sentimento segundo o dataset utilizado.</p>
</div>
<div class="section" id="em-que-o-lstm-ou-o-gru-poderao-influenciar">
<h2>2. Em quê o LSTM ou o GRU poderão influenciar?</h2>
<p>Em sua estrutura, a recorrêncida da RNN se resume a uma camada oculta, uma célula de recorrência que trata do gerenciamento de memória e a entrada, olhando com atenção, a célula fará basicamente é alterar os pesos da entrada de acordo com a camada oculta, que serve como uma memória, indicando o que valorizar ou não na etapa seguinte da execução da rede neural.</p>
<p>Traduzindo para o contexto da entrada conter a posição de cada palavra num hiperplano de acordo com o valor semântico expresso pelo uso demonstrado no dataset, isso quer dizer que será feito mais um ajuste sobre o skip-gram, na prática esse pós processamento vai indicar a importãncia de cada dimensão para cada palavra, potencializando o viés indicado pelo treinamento do skip-gram.</p>
<p>No PyTorch temos GRU e GRUCell, e LSTM e LSTMCell, a diferença é que usando simpelsmente GRU ou LSTM estamos inserindo uma pequena rede neural com a célula indicada no nome, podemos variar a quantidade de camadas lineares e definir uma taca pra o dropout, etc, mas se usarmos GRUCell ou LSTMCell teremos apenas a célula, no experimento feito, escolhi a 1ª opção pois não custava nada para mim definir logo o dropout em vez de definir ele em algum outro ponto.</p>
<p>Como este é um simples teste para ver o impacto da recorrência, resolvi manter apenas uma memória de curto prazo (reicinializando a cada novo uso da rede neural) para mostrar que mesmo com um uso mínimo as diferenças já são notáveis.</p>
</div>
<div class="section" id="se-a-entrada-tem-tamanho-variavel-como-internamente-fica-a-rede-neural">
<h2>3. Se a entrada tem tamanho variável, como internamente fica a rede neural?</h2>
<p>Em algum momento precisaremos de um tamanho fixo para passar pelas funções lineares, para o experimento atual apenas concatenei a matriz devolvida pelo GRU/LSTM, queria testar nas condições mais adversas, no próximo post aplicarei nesta etapa da execução tanto a convolução 1d quanto a convolução 2d, mas não há como fugir do tamanho fixo em algum momento neste caso, então a regra que usamos no post anterior de considerar o caso com maior quantidade de palavras vale aqui também.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name">
<col class="field-body">
<tbody valign="top"><tr class="field">
<th class="field-name">obs:</th>
<td class="field-body">um dos problemas do tamanho variável da entrada está no DataLoader do pytorch, ele lança um erro quando definimos um batch_size que nos deixe confortáveis, para trabalhar com dados em lotes ele exige tamanho fixo, de modo que só nos resta ler 1 item do dataset por vez, deixando o processo muito lento já que a cada item lido será aplicada uma etapa do treinamento, vamos ver a evolução mais rápida considerando as épocas mas a quantidade de vezes que os pesos foram atualizados correspondem a $n_epocas * n_items$</td>
</tr></tbody>
</table>
</div>
<div class="section" id="conclusoes">
<h2>Conclusões</h2>
<img alt="/images/classification_gru_ltsm.png" src="images/classification_gru_ltsm.png"><p>É notável e incrível a diferença do uso de redes recorrentes para lidar com linguagem, a grande diferença está no foco da recorrência: enquanto habitualmente ajustamos pesos para classificação, aqui transformamos os valores de entrada e diferentemente da convolução, não espalhamos informações nem produzimos matrizes ou arrays equivalente mas ajustamos a entrada de modo a se adequar melhor ao contexto do treinamenhto, e o melhor de tudo: sabendo lidar com sequências em nível mais abstrato do que apenas arrays e matrizes, o contexto envolta da ordem que as palavras são usadas nas frases tem relevância para a recorrência, e mesmo aplicando tão minimamente e de forma tão pouco eficiente neste exemplo, o resultado já superou largamente o uso de redes convolucionais demonstradas na anotação anterior.</p>
<p>No próximo post vou misturar as coisas, aplicando a recorreência, depois convlução (1d e 2d), e por último camadas lineares, assim espero concluir os modelos temporariamente e fazer uma análise geral sobre o que os métodos apresentados ao longo dessas anotações sobre classificação influenciam os resultados.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/resumos-0-pagerank/" class="u-url">Resumos 0: PageRank</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/resumos-0-pagerank/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-25T13:31:18-03:00" itemprop="datePublished" title="2018-12-25 13:31">2018-12-25 13:31</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/resumos-0-pagerank/#disqus_thread" data-disqus-identifier="cache/posts/resumos-0-pagerank.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Esta é uma anotação introdutória ao problema de resumir textos, o ponto principal abordado aqui será a dificuldade de identificar o que é relevante, para isso usei o textrank, não entrarei em muitos detalhes sobre esse algoritmo, tratando de forma intuitiva a idéia geral que será mais aprofundada em anotações posteriores.</p>
<p>PageRank foi o primeiro algoritmo usado pelo google para rankear os links de sua busca, logicamente o google evoluiu neste tempo todo e usa uma combinação de vários algoritmos e não o pagerank puro, aqui o usaremos para rankear os parágrafos de um texto da wikipedia.</p>
<div class="section" id="funcionamento">
<h2>Funcionamento</h2>
<p>Não entrarei em muitos detalhes sobre o algoritmo, então explicando de forma superficial temos o fato do pagerank se valer de um grafo, e ao considerar o grau de cada nó, ou seja a quantidade de conexões de cada nó, e um peso atribuído a cada conexão, teremos um ranking de importância. Até mesmo explicando desse modo já imaginamos como o algoritmo se aplica bem a links entre páginas na internet, mas para textos ele realmente não é tão adequado porém é didático como algo introdutório.</p>
<p>Os passos do "resumo" que na verdade é um rankeamento:</p>
<ol class="arabic simple">
<li>extrair estatísticas do texto (<a class="reference external" href="posts/estatistica-tf-idf-e-lsa">tf-idf</a> ou <a class="reference external" href="posts/word2vec-1-introducao">word2vec</a>, enfim, qualquer coisa que nos diga algo sobre o texto)</li>
<li>gerar uma matriz de similaridade, que na verdade servirá como matriz adjacente</li>
<li>converter a matriz adjacente num grafo</li>
<li>aplicar o PageRank</li>
</ol>
</div>
<div class="section" id="implementacao">
<h2>Implementação</h2>
<p>Resolvi o skip-gram já treinado[1]_ e a página da wikipédia sobre Alan Turing como já feito antes, o processamento realmente começa criando listas com os valores correspondentes a cada palavra indicado pelo skip-gram.</p>
<pre class="code python"><a name="rest_code_7f655bc01807478aaf8481b70fbbbc42-1"></a><span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_7f655bc01807478aaf8481b70fbbbc42-2"></a>
<a name="rest_code_7f655bc01807478aaf8481b70fbbbc42-3"></a><span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
<a name="rest_code_7f655bc01807478aaf8481b70fbbbc42-4"></a><span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">word2id</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">paragraph</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">id2word</span><span class="p">])</span>
</pre>
<p>O passo seguinte é criar uma matriz quadrada onde cada lado tem o nº de parágrafos, preenchi a matriz da seguinte forma:</p>
<pre class="code python"><a name="rest_code_d8741e6eb8c448659e1aecdaddf604bc-1"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sentences</span><span class="p">):</span>
<a name="rest_code_d8741e6eb8c448659e1aecdaddf604bc-2"></a>    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sentences</span><span class="p">):</span>
<a name="rest_code_d8741e6eb8c448659e1aecdaddf604bc-3"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="p">:</span>
<a name="rest_code_d8741e6eb8c448659e1aecdaddf604bc-4"></a>            <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a name="rest_code_d8741e6eb8c448659e1aecdaddf604bc-5"></a>                                          <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
<a name="rest_code_d8741e6eb8c448659e1aecdaddf604bc-6"></a>                                      <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre>
<p>O que é feito acima é apenas comparar a similaridade de cossenos entre cada parágrafo, indicando de alguma forma algum nível de similaridade, de modo que o parágrafo com maior <strong>índice de similaridade</strong> em relação aos demais será aquele que melhor representa o conjunto.</p>
<img alt="/images/similarity_matrix-classificacao-1.png" src="images/similarity_matrix-classificacao-1.png"><p>Essa é uma matriz simétrica que seŕá lida como uma matriz adjacente de um grafo, cada linha e coluna serão nós e cada corrdenada indica o peso do vértice que liga cada nó, um dos problemas dessa estratégia é que todos os nós terão o mesmo grau, já que todos se ligam a todos, isso acaba inutilizando o uso do grau de cada nó para o pagerank, tendo como único parâmetro a considerar o peso dos vértices.</p>
<pre class="code python"><a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-1"></a><span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_numpy_array</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">)</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-2"></a><span class="n">scores</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">pagerank</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-3"></a>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-4"></a><span class="n">original</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-5"></a>    <span class="nb">open</span><span class="p">(</span><span class="s2">"original_text-Alan_Turing.pickle"</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-6"></a>    <span class="p">)</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-7"></a>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-8"></a>    <span class="n">word_rank</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-9"></a>            <span class="p">[(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">original</span><span class="p">)],</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-10"></a>            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-11"></a>            <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-12"></a>    <span class="p">)</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-13"></a>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-14"></a>    <span class="n">qnt_lines</span> <span class="o">=</span> <span class="mi">3</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-15"></a>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-16"></a>    <span class="n">top</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">word_rank</span><span class="p">[:</span><span class="n">qnt_lines</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-17"></a>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-18"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qnt_lines</span><span class="p">):</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-19"></a>        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"-- parágrafo do resumo: {i} | parágrafo original: {top[i][1]}"</span><span class="p">)</span>
<a name="rest_code_987e3760b0b646bb83d961a7d99e45cd-20"></a>        <span class="k">print</span><span class="p">(</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
</pre>
<p>Na saída do código acima podemos reparar que a ordem de importância dada a cada parágrafo não necessariamente está relacionado ao seu tamanho ou à sua posição no texto:
.. epigraph:</p>
<pre class="literal-block">
-- parágrafo do resumo: 0 | parágrafo original: 19
Por muitos anos, foram feitas campanhas que envolveram ativistas da tecnologia da informação, do meio político e do público LGBT. Em 11 de setembro de 2009, 55 anos após sua morte, o primeiro-ministro do Reino Unido, Gordon Brown, seguindo um pedido feito através de uma petição direcionada ao governo britânico, pediu desculpas formais em nome do governo pelo tratamento preconceituoso e desumano dado a Turing, que o levou ao suicídio. Em 24 de dezembro de 2013, passou a ter efeito a Real Prerrogativa do Perdão, concedida a Turing pela Rainha Elizabeth II, a pedido do ministro da justiça do Reino Unido, Chirs Grayling, depois que uma petição criada em 2012 obteve mais de 37.000 assinaturas solicitando o devido perdão.

-- parágrafo do resumo: 1 | parágrafo original: 3
A homossexualidade de Turing resultou em um processo criminal em 1952, pois atos homossexuais eram ilegais no Reino Unido na época, e ele aceitou o tratamento com hormônios femininos e castração química, como alternativa à prisão. Morreu em 1954, algumas semanas antes de seu aniversário de 42 anos, devido a um aparente autoadministrado envenenamento por cianeto, apesar de sua mãe (e alguns outros) terem considerado sua morte acidental. Em 10 de setembro de 2009, após uma campanha de internet, o primeiro-ministro britânico Gordon Brown fez um pedido oficial de desculpas público, em nome do governo britânico, devido à maneira pela qual Turing foi tratado após a guerra. Em 24 de dezembro de 2013, Alan Turing recebeu o perdão real da rainha Elizabeth II, da condenação por homossexualidade.

-- parágrafo do resumo: 2 | parágrafo original: 12
Em 1938, Turing se uniu ao GC&amp;CS, o braço de decodificação de mensagens da inteligência britânica, para efetuar a Criptoanálise da Máquina Enigma. O Enigma era uma máquina de codificação que mudava seus códigos diariamente, obrigando a que o projeto de decifração se tornasse bastante rápido. Após o Reino Unido iniciar a Segunda Guerra Mundial ao declarar guerra à Alemanha em 1939, Turing foi direcionado para o quartel da GC&amp;CS em Bletchley Park. A partir de uma máquina decodificadora polonesa, Turing projetou a Bomba eletromecânica ("Bombe"),  um equipamento eletromecânico que ajudaria a decriptar as mensagens do Enigma e foi montada em 1940. Novas Bombas foram construídas após Turing e sua equipe pedirem apoio a Winston Churchill, e mais de duzentas operavam ao fim da Guerra em 1945. Turing também introduziu sua equipe em Bletchley Park ao matemático Tommy Flowers, que em 1943 projetou o Colossus, um computador primitivo que ajudou a decodificar outra máquina criptográfica alemã, o Lorenz.
</pre>
<p>Logicamente eu poderia ter usado frases em vez de parágrafos para fazer o resumo, talvez até fizesse mais sentido chamar a saída do código de resumo, mas resolvi usar parágrafos inteiros por considerar que a idéia fica mais clara assim e ao comparar com o texto original, fica mais visualmente evidente como se deu o trabalho do pagerank, nos próximos posts sobre este tópico serão mostradas redes neurais que fazem um trabalho bem mais coerente, logicamente usarei redes neurais recorrentes e o seq2seq, portanto recomendo que veja as anotações que escrevi sobre esses temas:</p>
<p><a class="reference external" href="posts/gru-e-lstm">GRU e LSTM</a>
<a class="reference external" href="posts/seq2seq-introducao">seq2seq: introdução</a></p>
<p>---</p>
<p>_[1] <a class="reference external" href="http://www.nilc.icmc.usp.br/nilc/index.php/repositorio-de-word-embeddings-do-nilc">http://www.nilc.icmc.usp.br/nilc/index.php/repositorio-de-word-embeddings-do-nilc</a></p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/classificacao-2-cnn/" class="u-url">Classificação 2: CNN</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/classificacao-2-cnn/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-25T05:17:55-03:00" itemprop="datePublished" title="2018-12-25 05:17">2018-12-25 05:17</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/classificacao-2-cnn/#disqus_thread" data-disqus-identifier="cache/posts/classificacao-2-cnn.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">os códigos estão aqui: <a class="reference external" href="https://github.com/demacdolincoln/test-sentiment_analysis">https://github.com/demacdolincoln/test-sentiment_analysis</a></p>
</div>
<p>Como falado <cite>anteriormente &lt;link://filename/posts/classificacao-1.rst&gt;_</cite>, classificar um texto é algo que vai além do vocabulário ainda que a gente utilize o word2vec ou o glove, e como a ordem das palavras importa muito, vamos dar aqui o 1º passo neste sentido, vamos ver como funciona uma rede neural convolucional (CNN) aplicada à classificação de textos.</p>
<p>Habitualmente elas são usadas essencialmente em processamento de imagens, no caso o que teremos é uma linha representando cada palavra e as colunas representando um ponto no hiperplano de acordo com a veotrização treinada. A idéia por trás da convolução aqui aplicada é bastante simples: ter uma matriz maior e calcular uma matriz menor equivalente, neste processo há perda de dados e portanto é irreversível, porém tem se demonstrado muito útil em muitos casos.</p>
<div class="section" id="implementacao">
<h2>Implementação:</h2>
<p>O primeiro passo é transformar um texto numa matriz, para isso vamos recordar o que temos:</p>
<ul class="simple">
<li>texto ~&gt; sequência de ids de palavras</li>
<li>skip-gram, cbow, glove, etc. ~&gt; representação cartesiana de palavras segundo o sentido compreendido pelo seu uso</li>
</ul>
<p>Diante disso se torna meio lógico fazer uma matriz no formato <cite>words x embedding dims</cite>.</p>
<p>Um dos problemas dessa abordagem é que frases tem tamanhos variáveis enquanto a matriz de entrada na camada convolucional da CNN precisa ter tamanho fixo, então temos de lidar sempre com o pior caso, frases grandes, e preencher o espaço restante das frases menores com zeros, isso acaba nos obrigando a ter um custo computacional extra já que teremos muitos espaços em branco só para que sempre tenhamos matrizes do mesmo tamanho.</p>
<p>Antes de continuar preciso fazer algumas observações:</p>
<ol class="arabic simple">
<li>Não encontrei um dataset em PTBR bom o suficiente, portanto, contrariando minha proposta inicial, o ciclo de anotações sobre classificação usará um dataset em inglês.</li>
<li>Tentei baixar um word embedding já treinado com o vocabulário da língua inglesa, mas ele tinha mais de 6Gb, como esse fato ia complicar algumas coisas a nível operacional, diminuindo minha proposta de fazer as anotações da forma mais simples possível, preferi usar o Gensim para calcular o skip-gram estrito ao dataset.</li>
</ol>
</div>
<div class="section" id="primeiros-passos">
<h2>Primeiros passos:</h2>
<ul class="simple">
<li>Baixar o dataset: link</li>
<li>E o de sempre conforme mostrado em <a class="reference external" href="filename://posts/word2vec-1-introducao.rst">Word2vec 1: introdução</a>
</li>
</ul>
<p>Sobre o tamanho das dimensões no word2vec: como neste caso precisamos de uma matriz quadrada, precisamos que a quantidade de dimensões seja a mesma do maior texto depois do processo de limpeza.</p>
<p>Após isso ser feito podemos montar as matrizes:</p>
<pre class="code python"><a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-1"></a><span class="k">def</span> <span class="nf">make_matrix</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">model_vec</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">stop_words</span><span class="p">):</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-2"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-3"></a>        <span class="n">phrase</span> <span class="o">=</span> <span class="n">gensim</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">simple_preprocess</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-4"></a>        <span class="n">phrase</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phrase</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stop_words</span><span class="p">]</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-5"></a>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-6"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-7"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phrase</span><span class="p">):</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-8"></a>        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">model_vec</span><span class="o">.</span><span class="n">wv</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-9"></a>            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">model_vec</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-10"></a>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-11"></a>    <span class="k">return</span> <span class="n">out</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-12"></a>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-13"></a><span class="k">class</span> <span class="nc">Data</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-14"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">stop_words</span><span class="p">):</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-17"></a>            <span class="p">[</span><span class="n">make_matrix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">stop_words</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-18"></a>        <span class="p">)</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span>  <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">target</span><span class="p">])</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-21"></a>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-22"></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-23"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-24"></a>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-25"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_0aeeabbc377c4dfc8a9082294fed8bdd-26"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>
</pre>
<p>Para facilitar a divisão do dataset para uma valização cruzada, usei o sklearn bem pontualmente:</p>
<pre class="code python"><a name="rest_code_8ad115fc588b40eaabb4b44b0888b3bd-1"></a><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">train_target</span><span class="p">,</span> <span class="n">test_target</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<a name="rest_code_8ad115fc588b40eaabb4b44b0888b3bd-2"></a>
<a name="rest_code_8ad115fc588b40eaabb4b44b0888b3bd-3"></a><span class="n">data_train</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_target</span><span class="p">,</span> <span class="n">skip_gram</span><span class="p">,</span> <span class="n">max_sentence</span><span class="p">,</span> <span class="n">stopw</span><span class="p">)</span>
<a name="rest_code_8ad115fc588b40eaabb4b44b0888b3bd-4"></a><span class="n">data_test</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_target</span><span class="p">,</span> <span class="n">skip_gram</span><span class="p">,</span> <span class="n">max_sentence</span><span class="p">,</span> <span class="n">stopw</span><span class="p">)</span>
</pre>
</div>
<div class="section" id="modelo-de-rede-neural">
<h2>Modelo de rede neural:</h2>
<p>A rede neural será uma rede convolucional bem padrão:</p>
<pre class="code python"><a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-1"></a><span class="k">class</span> <span class="nc">CNN_2D</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lin_in</span><span class="p">,</span> <span class="n">lin_out</span><span class="p">):</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-3"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-4"></a>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv0</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-6"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-7"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-8"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-9"></a>        <span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-10"></a>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-12"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-13"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-14"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-15"></a>        <span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-16"></a>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">lin_in</span><span class="p">,</span> <span class="n">lin_out</span><span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-18"></a>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-19"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-20"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-21"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-22"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-23"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a name="rest_code_a51030f6300d48fabc0d86b37ffc48ba-24"></a>        <span class="k">return</span> <span class="n">x</span>
</pre>
<p>Para entender melhor como a convolução funciona neste contexto, recomendo os vídeos:
* video1
* video2</p>
<p>Uma vantagem da convolução 2d (com uma matriz e não com um array) é uma maior propagação de informação sobre áreas tomadas pelos zeros, se formos imaginar o processo num array logo percebemos um espaço muito limitado de propagação das informações finais apenas. Para expor melhor as diferenças óbvias em se trabalhar com 1 e com 2 dimensões, também repeti o experimento com uma rede convolucional 1d, ela apresenta pouquíssimas diferenças: menores dimensões no skip-gram (apenas 10), 3 camadas lineares na rede neural, maior quantidade de épocas no treinamento. Em todos os casos resolvi usar uma função sigmoide na saída, isso para ter uma estimativa de "certeza" quanto às escolhas da rede neural após o treinamento, mas deixarei essa análise comparativa para o último post desse ciclo.</p>
<pre class="code python"><a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-1"></a><span class="k">class</span> <span class="nc">CNN_1D</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lin_in</span><span class="p">,</span> <span class="n">lin_out</span><span class="p">):</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-3"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-4"></a>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-6"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-7"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-8"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-9"></a>        <span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-10"></a>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-12"></a>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear0</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">lin_in</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">lin_in</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">lin_in</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">lin_in</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">lin_in</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">lin_out</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-16"></a>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-17"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-18"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-19"></a>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-20"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-21"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-22"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-23"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-24"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a name="rest_code_e08329b2b91c461e950a0bb63f69eac5-25"></a>        <span class="k">return</span> <span class="n">x</span>
</pre>
<p>Como acho a idéia aqui não ficou tão clara, antes de continuar, vou apenas ressaltar dimensões de entrada para cada rede neural:</p>
<ul>
<li>
<p class="first">Conv2d:</p>
<blockquote>
<ul class="simple">
<li>altura: tamanho máximo de palavras</li>
<li>largura: tamanho máximo de palavras</li>
<li>word embedding dims: tamanho máximo de palavras</li>
<li>a matriz será: palavras x word embedding</li>
</ul>
</blockquote>
</li>
<li>
<p class="first">Conv1d:</p>
<blockquote>
<ul class="simple">
<li>tamanho: tamanho máximo de palavras * word embedding dims</li>
<li>word embedding dims: qualquer tamanho que queira, no caso eu escolhi 10</li>
<li>o array será: dimensões de cada palavra lida na ordem colocada uma após a outra num array</li>
</ul>
</blockquote>
</li>
</ul>
</div>
<div class="section" id="treinamento">
<h2>Treinamento:</h2>
<p>Como pretendo fazer um post final de análise dos resultados, usei o ignite para organizar a criação de um csv e salvar a rede neural ao final do treinamento, não entrarei em muitos detalhes mas basta ver o notebook usado que (ao menos espero) fique bem clara a utilidade.</p>
<p>Em todos os experimentos, para as comparações serem mais justas, usarei essencialmente os mesmos parâmetros:</p>
<ul class="simple">
<li>loss function: Cross Entropy</li>
<li>Optimizer: Adam</li>
<li>learning rate: 0.001</li>
</ul>
<p>Apesar de ser um dataset muito pequeno, com apenas 3000 textos no total e invariavelmente fadado ao overfitting justamente por causa disso, a rede convolucional 2d funcionou muito melhor que a 1d como os gráficos abaixo claramente demonstram:</p>
<img alt="/images/classification_conv.png" src="images/classification_conv.png"><p><strong>resultado final:</strong></p>
<p>Na próxima anotação será a vez de tratar de redes recorrentes, serão no total 3 redes neurais (1 na próxima anotação e 2 na seguinte), inicialmente lidando apenas com a recorrência comparando o desempenho do GRU e LSTM e posteriormente combinado a recorrência com a convolução, mas para adiantar as coisas recomendo começar a ler a respeito do <a class="reference external" href="filename://posts/gru-e-lstm.rst">LSTM e GRU</a>.</p>
<p>---</p>
</div>
<div class="section" id="leituras-recomendadas">
<h2>Leituras recomendadas:</h2>
<p><a class="reference external" href="https://arxiv.org/abs/1408.5882">https://arxiv.org/abs/1408.5882</a></p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/gru-e-lstm/" class="u-url">GRU e LSTM</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/gru-e-lstm/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-24T02:13:54-03:00" itemprop="datePublished" title="2018-12-24 02:13">2018-12-24 02:13</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/gru-e-lstm/#disqus_thread" data-disqus-identifier="cache/posts/gru-e-lstm.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>obs: Não vou me demorar tratando de questões teóricas sobre as RNN em si, já que o foco dessas anotações é NLP, futuramente, ao concluir essas anotações talvez eu inicie uma série mais abrangente sobre machine learning, mas por enquanto apenas traterei de assuntos teóricos relativos a NLP e ao resto apenas uma abordagem prática.</p>
<p>Parece meio óbvio dizer mas o que define uma rede neural recorrente é exatamente a recorrência, isto é, informações que são armazenadas e depois reutilizadas, a forma mais simples de implementação consiste em criar uma camada (um array) que armazena os resultados e é utilizado normalmente no processamento dos dados que passam por uma rede neural, só que com 1 caracérística distinta: haver uma condição ou não para atualizar esses dados aprendidos ao longo do treinamento e uma condição que a informação armazenada seja utilizada.</p>
<p>Devido a esse mecanismo ser claramente um gerenciamento de memória e estarmos tratando de redes neurais, não demora muito para começarmos a associar ao modo como nosso cérebro gerencia a memória, desta forma vem ao mundo em 1997 o LSTM (Long Short-Term Memory) <a class="footnote-reference" href="posts/gru-e-lstm/#id4" id="id1">[1]</a> <a class="footnote-reference" href="posts/gru-e-lstm/#id5" id="id2">[2]</a>, e como o nome bem indica, se trata de gerenciamento de memória de curto e longo prazo, posteriormente, em 2014 nasce o GRU (Gated Recurrent Unit) <a class="footnote-reference" href="posts/gru-e-lstm/#id6" id="id3">[3]</a>, mantendo diversas semelhanças com o LSTM porém com um custo computacional um pouco menor mas que no geral tem um desempenho semelhante ainda que é comum encontrar artigos falando que um ou outro método funcionou bem melhor em algum caso específico. Mas aqui estamos tratando de entender por alto como funciona esse gerenciamento de memória, o que precisamos ter noção é de como eles fazem isso?</p>
<div class="section" id="portoes">
<h2>Portões</h2>
<p>Portões == funções</p>
<img alt="https://upload.wikimedia.org/wikipedia/commons/3/3b/The_LSTM_cell.png" src="https://upload.wikimedia.org/wikipedia/commons/3/3b/The_LSTM_cell.png"><object data="https://upload.wikimedia.org/wikipedia/commons/3/37/Gated_Recurrent_Unit%2C_base_type.svg" type="image/svg+xml">
https://upload.wikimedia.org/wikipedia/commons/3/37/Gated_Recurrent_Unit%2C_base_type.svg</object>
<p>Explicando as imagens acima: a primeira mostra como funciona o LSTM e a segunda mostra como funciona o GRU, ainda que os diagramas sejam diferentes, vemos que as funções usadas, os "portões" são os mesmos embora aplicados de diferentes formas, como são as funções que importam para entender aidéia geral, vou direto à explicação sobre as funções.</p>
<div class="math">
\begin{equation*}
\sigma = \frac{1}{1 + exp(-x)}
\end{equation*}
</div>
<div class="math">
\begin{equation*}
tanh = \frac{e^x - e^-x}{e^x + e^{-x}}
\end{equation*}
</div>
<img alt="/images/lstm_gru-tanh-sigmoid.png" src="images/lstm_gru-tanh-sigmoid.png"><p>Vemos que a diferença entre os gráficos dessas funções é essencialmente o limite quando tende a menos infinito, e isso faz toda a diferença, pois um limite que tende a 0 significa que posteriormente qualquer número multiplicado por 0 será 0, neste caso a função sigmoide indica a relevância de cada dimensão de entrada, se a dimensão for próxima a zero, ela vai perdendo relevância até desaparecer ou ser substituída por outra informação mais relevante (decidida pela função tanh).</p>
<p>Todo o mecanismo de preservação e esquecimento desses métodos se baseia nesses "portões" que é como são chamadas as camadas com a função sigmoide, enquanto a função tanh tem o dever de fazer as escolhas finais, repare nas somas e multiplicações que unem o fluxo da saída com a camada oculta que armazena a memória, como a última estapa das operações com o estado da célula é sempre uma soma e os anteriores são multiplicações, isso revela a alteração dos pesos para definir a importância de cada dimensão e posteriormente a atualização mantendo assim para a época atual do treinamento da rede neural, a memória de curto prazo (os espaços próximos a zero que após a soma se mantém próximos aos resultados mais recentes) e a memória de longo prazo (o conteúdo mais relevante deixado mais próximo de 1)</p>
<p>---</p>
</div>
<div class="section" id="artigos-e-links-recomendados">
<h2>artigos e links recomendados</h2>
<p>Uma das melhores explicações que já encontrei sobre LSTM e GRU: <a class="reference external" href="https://towardsdatascience.com/illustrated-guide-to-lstms-and-gru-s-a-step-by-step-explanation-44e9eb85bf21">Illustrated Guide to LSTM’s and GRU’s: A step by step explanation</a></p>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label"><a class="fn-backref" href="posts/gru-e-lstm/#id1">[1]</a></td>
<td><a class="reference external" href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.55.5709">Learning to Forget: Continual Prediction with LSTM ( Felix A. Gers , Jürgen Schmidhuber , Fred Cummins )</a></td>
</tr></tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label"><a class="fn-backref" href="posts/gru-e-lstm/#id2">[2]</a></td>
<td><a class="reference external" href="https://www.researchgate.net/profile/Sepp_Hochreiter/publication/13853244_Long_Short-term_Memory/links/5700e75608aea6b7746a0624/Long-Short-term-Memory.pdf?origin=publication_detail">Long short-term memory (Sepp Hochreiter; Jürgen Schmidhuber)</a></td>
</tr></tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label"><a class="fn-backref" href="posts/gru-e-lstm/#id3">[3]</a></td>
<td><a class="reference external" href="https://arxiv.org/pdf/1406.1078v3.pdf">Learning Phrase Representations using RNN Encoder–Decoder for Statistical Machine Translation ( Cho, Kyunghyun; van Merrienboer, Bart; Gulcehre, Caglar; Bahdanau, Dzmitry; Bougares, Fethi; Schwenk, Holger; Bengio, Yoshua)</a></td>
</tr></tbody>
</table>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/seq2seq-implementacao/" class="u-url">Seq2Seq - Implementação</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/seq2seq-implementacao/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-24T02:13:25-03:00" itemprop="datePublished" title="2018-12-24 02:13">2018-12-24 02:13</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/seq2seq-implementacao/#disqus_thread" data-disqus-identifier="cache/posts/seq2seq-implementacao.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <span></span>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/seq2seq-introducao/" class="u-url">Seq2Seq - Introdução</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/seq2seq-introducao/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-24T02:13:03-03:00" itemprop="datePublished" title="2018-12-24 02:13">2018-12-24 02:13</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/seq2seq-introducao/#disqus_thread" data-disqus-identifier="cache/posts/seq2seq-introducao.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Tenho certeza que todos ao menos uma vez se perguntaram, pelo menos nas primeiras vezes que usaram o google translate, "como é que isso funciona? é magica?", até mesmo pelo que escrevi aqui até agora, todos os conteúdos estão bastante distantes de algo que trate tão intensamente com linguagem do que o desta anotação. O seq2seq nos permite criar redes que aprendam a sequência em que as palavras estão dispostas num texto de modo que fique fácil gerar textos, por hora, para simplificar esse assunto bastante extendo, traterei aqui apenas de explicar cada passo praticamente sem o código e na próxima anotação terá uma implementação completa.</p>
<div class="section" id="encoder-decoder">
<h2>encoder - decoder</h2>
<p>O grande "truque" está no mecanismo de codificação-decodificação, na prática são 2 redes neurais recorrentes bem simples que compartilham uma mesma camada oculta e não tem camada de ativação, só uma célula <a class="reference external" href="posts/gru-e-lstm">GRU ou LSTM</a> que realiza o processamento.</p>
<p>A informação que dá sentido à ambas as redes é a camada oculta, é sobre ela que incide o treinamento, portanto essa é a camada responsável por fazer a relação entre as saídas de cada rede neural.</p>
<p>Então o que temos até o momento é:</p>
<ul>
<li>
<p class="first">encoder:</p>
<blockquote>
<ul class="simple">
<li>hidden layer</li>
<li>gru</li>
</ul>
</blockquote>
</li>
<li>
<p class="first">decoder:</p>
<blockquote>
<ul class="simple">
<li>hidden layer</li>
<li>gru</li>
</ul>
</blockquote>
</li>
</ul>
</div>
<div class="section" id="treinamento">
<h2>Treinamento</h2>
<p>Como já disse que tudo está em torno da camada oculta compartilhada, é criando este array que se inicia o treinamento, que incide mais sobre a camada de decodificação que sobre a de encodificação, é feito desse modo pela camada de decodificação ser a usada para calcular a perda já que é ela que nos fornecerá a saída final do algoritmo.</p>
<p>Procedimento:</p>
<ul class="simple">
<li>hidden layer</li>
<li>encoder_output, hidden_layer = encoder(input, hidden_layer)</li>
<li>decoder_output, hidden_layer = decoder(encoder_output, hidden_layer)</li>
<li>loss(decoder_output, target)</li>
<li>backward</li>
<li>step</li>
</ul>
<p>Na próxima anotação sobre o seq2seq, diante do código, tudo ficará mais claro.</p>
<p>Resolvi não colocar imagens ilustrativas aqui pois no 1º link das leituras recomendadas há um monte de animações explicando bem detalhadamente todo o processo, das 2 leituras recomendadas, essa é a que mais recomendo.</p>
<p>---</p>
</div>
<div class="section" id="leituras-recomendadas">
<h2>leituras recomendadas</h2>
<ul class="simple">
<li><a class="reference external" href="http://jalammar.github.io/visualizing-neural-machine-translation-mechanics-of-seq2seq-models-with-attention/">http://jalammar.github.io/visualizing-neural-machine-translation-mechanics-of-seq2seq-models-with-attention/</a></li>
<li><a class="reference external" href="https://google.github.io/seq2seq/">https://google.github.io/seq2seq/</a></li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/classificacao-1/" class="u-url">Classificação 1</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/classificacao-1/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-24T02:12:26-03:00" itemprop="datePublished" title="2018-12-24 02:12">2018-12-24 02:12</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/classificacao-1/#disqus_thread" data-disqus-identifier="cache/posts/classificacao-1.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>O problema fundamental da classificação de textos reside no fato da dificuldade de representar o texto a nível numérico, ainda que o word2vec, o glove, o seq2seq sejam realmente úteis assim como vários outros algoritmos que não incluí aqui mas que são facilmente encontrados em buscas no google, eles por si só não conseguem ir além da representação semântica ou de alguma outra lógica sobre as palavras, tanto para gerar textos quanto para classificá-los precisamos do auxílio de outros algoritmos. O objetivo desta anotação é identificar os desafions inerentes a esta tarefa.</p>
<div class="section" id="apenas-vocabulario">
<h2>Apenas vocabulário</h2>
<p>Esse seria o caminho mais óbvio, tendo em vista que temos uma representação espacial da disposição das palavras num hiperplano, então faz sentido imaginar que textos sobre diferentes assuntos necessariamente tem diferentes vocabulários. Façamos um teste:</p>
<ol class="arabic">
<li>
<p class="first">peguei 2 textos da wikipedia:</p>
<blockquote>
<ol class="loweralpha simple">
<li>
<a class="reference external" href="https://pt.wikipedia.org/wiki/Lutefisk">Lutefisk</a> - um prato da culinária norueguesa</li>
<li>
<a class="reference external" href="https://pt.wikipedia.org/wiki/Erhu">Erhu</a> - um instrumento tradicional chinês</li>
</ol>
</blockquote>
</li>
<li>
<p class="first">fiz o pré-processamento das palavras como já descrito em outro post, ficando apenas com o vocabulário</p>
</li>
<li>
<p class="first">peguei as posições correspondentes a cada palavra no skip-gram já treinado</p>
</li>
<li>
<p class="first">reduzi as dimensões e plotei o gráfico</p>
</li>
</ol>
<img alt="/images/classificacao_1_scatter_vec.png" src="images/classificacao_1_scatter_vec.png"><p><strong>explicando as cores:</strong></p>
<!-- vermelho: vocabulário do texto 1 -->
<!-- ciano: vocabulário do texto 2 -->
<!-- branco: vocabulário em comum a ambos -->
<p>Como é possível perceber acima, não identificamos um nível de separação consistente entre os vocabulários, olhando a densidade de concentração do vocabulário nos dois textos, descartando as palavras em comum, temos a imagem abaixo:</p>
<img alt="/images/classificacao_1_kde_vec.png" src="images/classificacao_1_kde_vec.png"><p>Os centros estão muito próximos, ou seja, mesmo identificando as regiões mais densas nos vocabulários, ao tentar usar esta região como métrica, a similaridade de sentido entre os termos para o texto 1 e para o texto 2 continuam muito próximas tornando essa estratégia bem ineficaz.</p>
<p>A solução está na compreensão que um texto não são apenas palavras soltas, mas o sentifo extrapola a simples junção de palavras, então a ordem do que está escrito importa, a disposição das palavras no texto importa muito.</p>
<p>Nas próximas anotações abordarei sobre o uso de redes convolucionais e redes neurais recorrentes, diferentes formas de tentar burlar as dificuldades aqui apresentadas.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/" class="u-url">Distância Euclidiama vs Similaridade de Cossenos</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-07T04:04:17-03:00" itemprop="datePublished" title="2018-12-07 04:04">2018-12-07 04:04</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#disqus_thread" data-disqus-identifier="cache/posts/distancia-euclidiama-vs-similaridade-de-cossenos.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Indo direto ao ponto a principal diferença entre os cálculos é que enquanto na distância euclidiana é como se fizéssemos uma medição com uma régua entre 2 pontos, na similaridade de cossenos analisamos a distância angular entre 2 pontos a partir da origem, isso ficará mais claro no gráfico perto do final desta anotação.</p>
<div class="math">
\begin{equation*}
dist\_eucl = \sqrt{\sum{(a-b)^2}}
\end{equation*}
</div>
<div class="math">
\begin{equation*}
cosine\_sim = \frac{\sqrt{\sum{a * b}}}{\sqrt{\sum{a^2}} * \sqrt{\sum{b^2}}}
\end{equation*}
</div>
<div class="section" id="comparando-resultados">
<h2>Comparando resultados</h2>
<p>Primeiro vamos implementar cada cálculo e depois uma função que receba uma matriz, normalize os dados, e indike os "k" pontos mais próximos a alguma coordenada que a gente escolher. Como usaremos em outras anotações, escrevi mais linhas do que um código simples e didático deveria ter:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-1"> 1</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-2"> 2</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-3"> 3</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-4"> 4</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-5"> 5</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-6"> 6</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-7"> 7</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-8"> 8</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-9"> 9</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-10">10</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-11">11</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-12">12</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-13">13</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-14">14</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-15">15</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-16">16</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-17">17</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-18">18</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-19">19</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-20">20</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-21">21</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-22">22</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-23">23</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-24">24</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-25">25</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-26">26</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-27">27</a>
<a href="posts/distancia-euclidiama-vs-similaridade-de-cossenos/#rest_code_7361953c4e44408fbac34e1192d4a6f5-28">28</a></pre></div></td>
<td class="code"><pre class="code python"><a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-2"></a><span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">euclidean</span><span class="p">,</span> <span class="n">cosine</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-3"></a>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-4"></a><span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-5"></a>    <span class="k">return</span> <span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-6"></a>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-7"></a><span class="k">def</span> <span class="nf">knn</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s2">"cos"</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-8"></a>    <span class="n">data_norm</span><span class="p">,</span> <span class="n">coord_norm</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-9"></a>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-10"></a>    <span class="k">if</span> <span class="s2">"coord"</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-11"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">matrix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kw</span><span class="p">[</span><span class="s2">"coord"</span><span class="p">]])))</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-12"></a>        <span class="n">ata_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-13"></a>        <span class="n">coord_norm</span> <span class="o">=</span> <span class="n">data_norm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-14"></a>    <span class="k">else</span><span class="p">:</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-15"></a>        <span class="n">data_norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-16"></a>        <span class="n">coord_norm</span> <span class="o">=</span> <span class="n">data_norm</span><span class="p">[</span><span class="n">kw</span><span class="p">[</span><span class="s2">"pos"</span><span class="p">]]</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-17"></a>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-18"></a>    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-19"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_norm</span><span class="p">:</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-20"></a>        <span class="k">if</span> <span class="n">func</span><span class="o">==</span><span class="s2">"cos"</span><span class="p">:</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-21"></a>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cosine</span><span class="p">(</span><span class="n">coord_norm</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-22"></a>        <span class="k">else</span><span class="p">:</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-23"></a>            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">euclidean</span><span class="p">(</span><span class="n">coord_norm</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-24"></a>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-25"></a>    <span class="k">if</span> <span class="n">func</span><span class="o">==</span><span class="s2">"cos"</span><span class="p">:</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-26"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-27"></a>    <span class="k">else</span><span class="p">:</span>
<a name="rest_code_7361953c4e44408fbac34e1192d4a6f5-28"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</pre></td>
</tr></table>
<p>Visualizando a diferença de resultados entre as medições, gerei esse gráfico abaixo:</p>
<a class="reference external image-reference" href="images/eucl_vs_cos.png"><img alt="/images/eucl_vs_cos.thumbnail.png" src="images/eucl_vs_cos.thumbnail.png" style="width: 500px;"></a>
<p>explicando: os pontos vermelhos representam os pontos mais próximos desse ponto amarelo cortado por uma seta são os pontos mais próximos considerando a distância euclidiana, os pontos azuis é pela similaridade de cossenos e os roxos são os que as duas métricas coincidem ao listar os mais próximos, a seta indica a inclinação do ponto amarelo em relação a origem, e é isso que a similaridade de cossenos leva em consideração, perceba que um dos pontos azuis ficou bem distante mas projetando a seta vemos que se mantém mais próximo ao ângulo do ponto amarelo que o ponto vemelho.</p>
<p>O motivo de preferirmos usar a similaridade de cossenos a usar distância euclidiana ou outras métricas para medir distâncias é que quando trabalhamos com NLP e ainda mais quando fazemos uma redução de dimensionalidade (onde ficou claro que há rotação e distorção) os ângulos ficam mais bem preservados que as distâncias.</p>
<p>obs: É muito comum a similaridade é calculada com 1 passo a mais do que o demonstrado aqui, a distância angular é dada por:</p>
<div class="math">
\begin{equation*}
dist\_angular = \frac{cos^-1(cos\_similarity)}{\pi}
\end{equation*}
</div>
<div class="math">
\begin{equation*}
angular\_similarity = 1-dist\_angular
\end{equation*}
</div>
<p>Outras vezes apenas fazem <strong>1-similaridade</strong>.</p>
<div class="notebook">
    <a class="notebook-link" href="http://nbviewer.jupyter.org/github/demacdolincoln/anotacoes-nlp/blob/src/files/knn_eucl_cos.ipynb">code</a>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/estatistica-tf-idf-e-lsa/" class="u-url">Estatística: TF-IDF e LSA</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Lincoln de Macêdo
            </span></p>
            <p class="dateline">
            <a href="posts/estatistica-tf-idf-e-lsa/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-07T01:47:59-03:00" itemprop="datePublished" title="2018-12-07 01:47">2018-12-07 01:47</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/estatistica-tf-idf-e-lsa/#disqus_thread" data-disqus-identifier="cache/posts/estatistica-tf-idf-e-lsa.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Antes da popularidade de métodos baseados em IA, muito também devido à capacidade dos computadores da época, o que restava para análises de texto era quantificar as palavras e buscar extrair estatísticas, o mais básico e fundamental talvez seja o TF-IDF e por isso este post.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name">
<col class="field-body">
<tbody valign="top"><tr class="field">
<th class="field-name">tf-idf:</th>
<td class="field-body"><em>frequency-inverse document frequency</em></td>
</tr></tbody>
</table>
<p>Este método se resume a contar a frequência de uso de palavras e realizar um cálculo que gere uma estimativa de uso/importância da palavra no texto, de certa forma ele se conecta à <a class="reference external" href="https://en.wikipedia.org/wiki/Zipf%27s_law">Lei de Zipf</a> que trata justamente de uma análise da frequência de palavras.</p>
<div class="math">
\begin{equation*}
TF(t) = \frac{nº\ de\ vezes\ que\ t\ aparece\ no\ texto}{total\ de\ termos\ no\ texto}
\end{equation*}
</div>
<div class="math">
\begin{equation*}
IDF(t) = log_e(\frac{quantidade\ total\ de\ textos}{numero\ de\ textos\ em\ que\ t\ aparece})
\end{equation*}
</div>
<p>Recomendo bastante a wikipédia em inglês, há bastante exemplos de cálculos variantes: <a class="reference external" href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">https://en.wikipedia.org/wiki/Tf%E2%80%93idf</a></p>
<p>Logicamente há inconsistências, afinal apenas a frequência não alcança o uso das palavras, não indica necessariamente as mais significativas se uma pessoa em vez de fazer referências a uma palavra ficar repetindo a mesma coisa o tempo todo. ex.:</p>
<!--  -->
<blockquote>
<p>"há filmes bons, ruins e medianos, mas o filme em questão é o pior de todos, o filme é tão chato e cansativo que todos dormem assistindo os primeiros minutos do filme"</p>
<p>"há filmes bons, ruins e medianos, mas este em questão é o pior de todos, tão chato e cansativo que todos dormem aos primeiros minutos"</p>
</blockquote>
<p>É bem claro que apesar do sentido do texto ser o mesmo, a importância dada à palavra "filme" seria diferente. E de fato, o TF-IDF funciona melhor para textos que seguem as regras de coesão e coerência, então vamos usar publicações da wikipédia.</p>
<p>Apesar do cálculo ser bastante simples, vou preferir usar o sklearn pois neste caso o mais importante é ter uma ideia geral sobre um recurso básico e servir como uma introdução básica sobre NLP, especialmente sobre vertorização de textos</p>
<div class="section" id="tf-idf">
<h2>TF-IDF</h2>
<p>Como quase tudo no sklearn...</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-1"> 1</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-2"> 2</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-3"> 3</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-4"> 4</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-5"> 5</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-6"> 6</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-7"> 7</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-8"> 8</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-9"> 9</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-10">10</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-11">11</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-12">12</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-13">13</a>
<a href="posts/estatistica-tf-idf-e-lsa/#rest_code_7cb1fdbb029842fa809f3b6af21acd22-14">14</a></pre></div></td>
<td class="code"><pre class="code python"><a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-1"></a><span class="kn">import</span> <span class="nn">wikipedia</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-2"></a><span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-3"></a><span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-4"></a>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-5"></a><span class="n">stopw</span> <span class="o">=</span> <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"portuguese"</span><span class="p">)</span> <span class="o">+</span>\
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-6"></a>        <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">"english"</span><span class="p">)</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-7"></a>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-8"></a><span class="n">wikipedia</span><span class="o">.</span><span class="n">set_lang</span><span class="p">(</span><span class="s2">"pt"</span><span class="p">)</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-9"></a><span class="n">text</span> <span class="o">=</span> <span class="n">wikipedia</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="s2">"Alan_Turing"</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-10"></a>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-11"></a><span class="n">tfidf</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">stop_words</span><span class="o">=</span><span class="n">stopw</span><span class="p">)</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-12"></a>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-13"></a><span class="n">X</span> <span class="o">=</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
<a name="rest_code_7cb1fdbb029842fa809f3b6af21acd22-14"></a><span class="n">X</span><span class="o">.</span><span class="n">shape</span>
</pre></td>
</tr></table>
<p>Na penúltima linha usei o <cite>splitlines</cite> para dividir o texto em parágrafos, assim podemos posteriormente coletar informações sobre os termos relevantes para cada parágrafo, mas admito esta forma ser demasiadamente simplista pois neste caso acabo considerando subtítulos como parágrafos.</p>
<p>Internamente, o objeto que criamos, durante o treinamento, armazena um dicionário com as palavras e um "id", vamos usar isso para converter os termos:</p>
<pre class="code python"><a name="rest_code_aaf91543a0d342dcac0dc2d7b53ad8d2-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">X</span>
<a name="rest_code_aaf91543a0d342dcac0dc2d7b53ad8d2-2"></a><span class="o">&lt;</span><span class="mi">61</span><span class="n">x664</span> <span class="n">sparse</span> <span class="n">matrix</span> <span class="n">of</span> <span class="nb">type</span> <span class="s1">'&lt;class '</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="s1">'&gt;'</span>
<a name="rest_code_aaf91543a0d342dcac0dc2d7b53ad8d2-3"></a>    <span class="k">with</span> <span class="mi">862</span> <span class="n">stored</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">Compressed</span> <span class="n">Sparse</span> <span class="n">Row</span> <span class="n">format</span><span class="o">&gt;</span>
</pre>
<p>A matriz esparsa tem diversas vantagens quando tratamos com longos arrays rechados de zeros, talvez o produto principal nessa implementação seja exatamente essa matriz que indica em cada parágrafo quais os termos presentes e a sua frequência, que é o ponto principal do TF-IDF.</p>
<img alt="visualização da matriz resultante" src="images/lsa.png"><p>E é exatamente sobre essa matriz que chegamos no LSA (Latent Semantic Analysis), mas antes vamos ver quais as palavras mais relevantes do primeiro parágrafo:</p>
<pre class="code python"><a name="rest_code_93175e2afb5b462d871d714b20642d30-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">ft_name</span> <span class="o">=</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">top_tfidf</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_tfidf</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-4"></a>        <span class="k">print</span><span class="p">(</span><span class="n">ft_name</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-5"></a>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-6"></a><span class="n">computação</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-7"></a><span class="n">cheshire</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-8"></a><span class="n">junho</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-9"></a><span class="n">ciência</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-10"></a><span class="n">influente</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-11"></a><span class="n">algoritmo</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-12"></a><span class="n">east</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-13"></a><span class="n">lógico</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-14"></a><span class="n">desenvolvimento</span>
<a name="rest_code_93175e2afb5b462d871d714b20642d30-15"></a><span class="n">desempenhando</span>
</pre>
<p>O ft_name é a lista de termos que irá converter para string a posição do termo indicada quando ordenamos o array comtendo o valor calculado para cada termo devolvendo as respectivas posições.</p>
</div>
<div class="section" id="lsa">
<h2>LSA</h2>
<p>O LSA é nada mais que usar o <a class="reference external" href="posts/svd-vs-pca">SVD</a> mas em vez de diminuir as dimensões vamos manter o tamanho da matriz:</p>
<pre class="code python"><a name="rest_code_8576c53e09a1446d9c200ae950318432-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<a name="rest_code_8576c53e09a1446d9c200ae950318432-2"></a><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="mi">664</span><span class="p">)</span>
<a name="rest_code_8576c53e09a1446d9c200ae950318432-3"></a>
<a name="rest_code_8576c53e09a1446d9c200ae950318432-4"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">lsa</span> <span class="o">=</span> <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<a name="rest_code_8576c53e09a1446d9c200ae950318432-5"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">lsa</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<a name="rest_code_8576c53e09a1446d9c200ae950318432-6"></a><span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="s1">'randomized'</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a name="rest_code_8576c53e09a1446d9c200ae950318432-7"></a>   <span class="n">random_state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</pre>
<p>O real poder do LSA vem desse tratamento dado à matriz formada a partir do TF-IDF, o código abaixo indica as palavras mais relevantes para cada parágrafo:</p>
<pre class="code python"><a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-1"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lsa</span><span class="o">.</span><span class="n">components_</span><span class="p">):</span>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-2"></a>    <span class="n">terms_in_comp</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ft_name</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-3"></a>    <span class="n">sorted_terms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">terms_in_comp</span><span class="p">,</span>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-4"></a>                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-5"></a>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-6"></a>    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"paragrafo: {i}"</span><span class="p">)</span>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-7"></a>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sorted_terms</span><span class="p">:</span>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-8"></a>        <span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a name="rest_code_5eddfef9e5e04ca2a5e679e9a0e194e3-9"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"-"</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
</pre>
<p>Pegando apenas o parágrafo 0, o resultado que temos é:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name">
<col class="field-body">
<tbody valign="top"><tr class="field">
<th class="field-name">paragrafo 0:</th>
<td class="field-body"><ul class="first last simple">
<li>turing</li>
<li>máquina</li>
<li>alan</li>
<li>prêmio</li>
<li>memorial</li>
<li>guerra</li>
<li>enigma</li>
<li>bletchley</li>
<li>park</li>
<li>computação</li>
</ul></td>
</tr></tbody>
</table>
</div>
<div class="section" id="off-topic">
<h2>off-topic</h2>
<ol class="arabic simple">
<li>E para gerar estatísticas de relevância de um texto inteiro, basta não dividir em parágrafos</li>
<li>E para gerarmos aquele bag of words que está na moda temos algumas opções, dependendo do caso aplicamos só o <strong>TF</strong> para gerar um ranking, para outros casos o <strong>TF-IDF</strong> funciona melhor, especialmente quando juntamos vários textos como uma análise geral de várias páginas de blogs, o LSA tende a ser melhor em usos mais específicos porém nada impede de usa-lo para gerar o ranking de termos para um livro, por exemplo.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">notebook usado: <a class="reference external" href="http://nbviewer.jupyter.org/github/demacdolincoln/anotacoes-nlp/blob/src/files/estatistica-tf-idf-e-lsa.ipynb">link para o nbviewer</a></p>
</div>
</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-1.html" rel="next">Posts mais antigos</a>
            </li>
        </ul></nav><script>var disqus_shortname="demacdolincoln";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script></main><footer id="footer"><p>Contents © 2019         <a href="mailto:demacdolincoln@gmail.com">Lincoln de Macêdo</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    
    

    
    
    
</body>
</html>
